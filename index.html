<html>
<head>
    <style>
        body {
            font-family: Helvetica, Arial, sans-serif;
            background-color: white;
        }
        h1 {
            background-color: white;
            color:black;
            text-align: center;
            margin-top: 20px;
            font-family:Impact,fantasy;
        }

        h2{
            background-color: white;
            color:black;
            text-align: center;
        }
        svg{
            border-style:none;
            /* background-color:whitesmoke; */
        }

        .mainview{
            position:relative;
            display:flex;
            flex-direction:column;
            width: 80%;
            height: 100%;
            left: 10%;
        }

    </style>

    <script type='text/javascript' src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
    <h1> Baseball Game Video Feature vector</h1>
    <div class="mainview", id="TSNE">
        <h2>TSNE </h2>  
        <svg id="Scatter" ></svg>
    </div>
</body>

<script>
    let store={}
    const action='bbgame_swing_ball';
    const split='train';
    const date='0815';
    const json_path=`data/${action}_${split}_${date}_5000_embs.csv`;
    function loadData() {
        return Promise.all([
            d3.csv(json_path)
        ]).then(datasets =>{
            store.embs_dict=datasets[0];
            return store;
        })
    }

    function embsScatter(embs) {
        var width=d3.select(".mainview")
            .style("width")
            .slice(0,-2);
        var height=d3.select(".mainview")
            .style("height")
            .slice(0,-2);
        const margin={top:80,bottom:30,left:50,right:50};

        var maxWidth=d3.min([width*0.7,800]);
        var maxHeight=d3.min([height*0.5,500]);

        var svg=d3.select("#Scatter")
            .attr("width","100%")
            .attr("height","100%")
            // .style("font","14px");

        var body=svg.append("g")
            .style("transform",`translate(${margin.left}px,${margin.top}px)`);

        var dtwAArray=[];
        var dtwBArray=[];
        for (let d=0;d<embs.length;d++){
            if (+embs[d].seq_labels==0){
                dtwAArray.push(+embs[d].dtw);
            }else{
                dtwBArray.push(+embs[d].dtw);
            }
        }
        dtwAArray.sort(function(x,y){
            return d3.ascending(x,y);
        })
        dtwBArray.sort(function(x,y){
            return d3.ascending(x,y);
        })

        var domainA=[d3.quantile(dtwAArray,0),
            d3.quantile(dtwAArray,0.25),
            d3.quantile(dtwAArray,0.5),
            d3.quantile(dtwAArray,0.75),
            d3.quantile(dtwAArray,1)]
        var domainB=[d3.quantile(dtwBArray,0),
            d3.quantile(dtwBArray,0.25),
            d3.quantile(dtwBArray,0.5),
            d3.quantile(dtwBArray,0.75),
            d3.quantile(dtwBArray,1)]
        
        var domains=[domainA,domainB];

        var colorsA=['#edf8fb','#b2e2e2','#66c2a4','#2ca25f','#006d2c']; 
        var colorsB=['#feebe2','#fbb4b9','#f768a1','#c51b8a','#7a0177'];
        var colors=[colorsA,colorsB];
        // var R2B=['#d7191c','#fdae61','#ffffbf','#abdda4','#2b83ba'];
        
        var colorScaleA=d3.scaleLinear()
            .domain(domainA)
            .range(colorsA);
        var colorScaleB=d3.scaleLinear()
            .domain(domainB)
            .range(colorsB);

        var xScale=d3.scaleLinear()
            .range([0,maxWidth])
            .domain(d3.extent(embs.map(a=> eval(a.tsne)[0]*1.1)))
        var yScale=d3.scaleLinear()
            .range([maxHeight,0])
            .domain(d3.extent(embs.map(a=> eval(a.tsne)[1]*1.1)))

        var points=body.selectAll(".point")
        points.data(embs).enter()
            .append("path")
            .attr("class","point")
            .attr("d",d3.symbol().size("50").type(function(d){
                if(+d.seq_labels==0){
                    return d3.symbolCircle;
                }else{
                    return d3.symbolTriangle;
                }
            }))
            .attr("transform",function(d){
                return `translate(${xScale(eval(d.tsne)[0])},${yScale(eval(d.tsne)[1])})`;
            })
            .attr("fill-opacity",.7)
            .attr("fill",function(d){
                if(+d.seq_labels==0){
                    return colorScaleA(d.dtw)
                }else{
                    return colorScaleB(d.dtw)
                }
            });
        
        // Add axis
        
        var axisX=d3.axisBottom(xScale).tickSize(0);
        var axisY=d3.axisLeft(yScale).tickSize(0);

        svg.append("g")
            .style("font","12px")
            .style("transform",`translate(${margin.left}px,${margin.top+maxHeight}px)`)
            .call(axisX)
        svg.append("g")
            .style("font","12px")
            .style("transform",`translate(${margin.left}px,${margin.top}px)`)
            .call(axisY)
        
        // Add colorbars
        const lg_w=20;
        const lg_h=150;
        var lg_x;
        var lg_y;
        var defs=svg.append("defs");
        var linearGradient;
        for(var i=0;i<2;i++){
            lg_x=maxWidth+i*lg_w*2+50;
            lg_y=maxHeight-lg_h;

            linearGradient=defs.append("linearGradient")
                .attr("id","linear-gradient-"+i);
            linearGradient
                .attr("x1","100%")
                .attr("y1","100%")
                .attr("x2","100%")
                .attr("y2","0%");
            linearGradient.selectAll("stop")
                .data([
                    {offset:"0%",color:colors[i][0]},
                    {offset:"25%",color:colors[i][1]},
                    {offset:"50%",color:colors[i][2]},
                    {offset:"75%",color:colors[i][3]},
                    {offset:"100%",color:colors[i][4]},
                ]).enter()
                .append("stop")
                .attr("offset", function(d) { return d.offset; })
                .attr("stop-color", function(d) { return d.color; });

            body.append("rect")
                .attr("x",lg_x)
                .attr("y",lg_y)
                .attr("width",lg_w)
                .attr("height",lg_h)
                .attr("fill","url(#linear-gradient-"+i+")")
                .style("opacity",0.7);
            
            body.append("text")
                .style("font-size","12px")
        }
    }

    function showData(){
        let embs=store.embs_dict;

        embsScatter(embs);
    }
    loadData().then(showData);
</script>

</html>

<!-- 
    color template: 
        123f77 0f86b6 37cae5 f5db73
        2d3505 828227 aa3b00 d6873e
 -->